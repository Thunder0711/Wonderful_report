<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能测评系统 - 助手阿柴版</title>
    <style>
        /* --- 1. 基础样式与变量 --- */
        :root { 
            --ac-mint: #A8D5BA; 
            --ac-cream: #FDFaf5; 
            --ac-brown: #5B4636; 
            --ac-sand: #E6D5B8; 
            --primary-green: #88c0a7;
            --text-dark: #333;
            --text-light: #999;
            --card-bg: #ffffff;
            --border-color: #f0f0f0;
            --apple-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }

        body { 
            margin: 0; background-color: var(--ac-sand); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; 
        }

        .main-container { 
            width: 95vw; max-width: 650px; height: 85vh; 
            background: var(--ac-cream); border: 6px solid var(--ac-mint); 
            border-radius: 45px; display: flex; flex-direction: column; 
            position: relative; box-shadow: var(--apple-shadow); 
        }

        /* --- 2. 阿柴交互区域 --- */
        .shiba-container {
            position: absolute; top: -85px; left: 35px;
            width: 120px; height: 120px; z-index: 100;
        }
        #achai-img {
            width: 100%; height: auto;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
        }
        @keyframes shiba-float {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-6px) rotate(2deg); }
        }
        .shiba-idle { animation: shiba-float 3.5s infinite ease-in-out; }
        .shiba-fading { opacity: 0.3; transform: scale(0.9); }

        /* --- 3. 聊天 UI --- */
        #chat-window { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 18px; margin-top: 35px; scroll-behavior: smooth; }
        .msg { padding: 14px 20px; border-radius: 22px; max-width: 80%; line-height: 1.6; font-size: 15px; position: relative; }
        .bot { background: var(--ac-mint); align-self: flex-start; color: white; border-bottom-left-radius: 4px; }
        .user { background: white; align-self: flex-end; color: var(--ac-brown); border-bottom-right-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .typing-bubble { display: none; background: var(--ac-mint); padding: 12px 20px; border-radius: 20px; align-self: flex-start; margin-left: 25px; margin-bottom: 20px; opacity: 0.8; }
        .dot { display: inline-block; width: 6px; height: 6px; background: white; border-radius: 50%; margin-right: 4px; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1.2); opacity: 1; } }

        .input-area { padding: 20px; display: flex; gap: 12px; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border-top: 1px solid #EEE; border-radius: 0 0 45px 45px; }
        #user-input { flex: 1; padding: 14px 18px; border: 2px solid #EEE; border-radius: 16px; outline: none; transition: border 0.3s; }
        #user-input:focus { border-color: var(--ac-mint); }

        /* --- 4. 报告界面 --- */
        #report-overlay { display: none; position: fixed; inset: 0; z-index: 2000; background: #f8f9fa; overflow-y: auto; padding: 20px; }
        .report-content { width: 100%; max-width: 450px; margin: 0 auto; }
        
        .score-card { background: linear-gradient(180deg, #d8ece3 0%, #ffffff 100%); border-radius: 30px; padding: 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .score-big { font-size: 72px; font-weight: bold; color: #fff; text-shadow: 2px 2px 15px rgba(136, 192, 167, 0.5); line-height: 1; }
        .score-label { background-color: var(--primary-green); color: white; padding: 6px 20px; border-radius: 20px; font-size: 15px; display: inline-block; margin-top: 15px; font-weight: bold; }

        .tabs { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab { font-size: 14px; color: var(--text-light); cursor: pointer; padding: 10px 5px; transition: all 0.3s; flex: 1; text-align: center; }
        .tab.active { color: var(--text-dark); font-weight: bold; border-bottom: 3px solid var(--primary-green); }

        .chart-container { background: var(--card-bg); border-radius: 30px; padding: 60px 20px; text-align: center; margin-bottom: 20px; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.03); min-height: 220px; display: flex; justify-content: center; align-items: center; }
        
        .radar-wrapper { width: 220px; height: 220px; margin: 0 auto; position: relative; display: none; }
        .dim-label { position: absolute; font-size: 12px; color: #333; font-weight: bold; display: flex; flex-direction: column; align-items: center; white-space: nowrap; }
        .pos-0 { top: -50px; left: 50%; transform: translateX(-50%); }
        .pos-1 { bottom: -15px; right: -40px; }
        .pos-2 { bottom: -15px; left: -40px; }

        .progress-wrapper { display: none; width: 100%; justify-content: space-around; align-items: flex-end; }
        .prog-item { display: flex; flex-direction: column; align-items: center; position: relative; }
        .prog-svg { transform: rotate(-90deg); width: 100px; height: 100px; }
        .prog-bg { fill: none; stroke: #edf2f0; stroke-width: 8; }
        .prog-bar { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
        .prog-val { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); font-size: 14px; font-weight: bold; color: var(--text-dark); }
        .prog-name { margin-top: 10px; font-size: 13px; font-weight: bold; color: #333; }

        .grid-circle { fill: none; stroke: #edf2f0; stroke-width: 1; }
        .data-area { fill: rgba(136, 192, 167, 0.2); stroke: var(--primary-green); stroke-width: 2.5; transition: all 0.5s ease; }
        .data-point { fill: var(--primary-green); stroke: #fff; stroke-width: 2; }

        .info-card { background: var(--card-bg); border-radius: 25px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .card-header { font-weight: bold; margin-bottom: 12px; font-size: 15px; display: flex; align-items: center; }
        .card-header::before { content: ""; width: 4px; height: 14px; background: var(--primary-green); margin-right: 8px; border-radius: 2px; }

        .level-tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; margin-top: 4px; border: 1px solid transparent; }
        .tag-concern { color: #ff4d4f; background-color: #fff2f0; border-color: #ffccc7; }
        .tag-good { color: #1890ff; background-color: #e6f7ff; border-color: #91d5ff; }
        .tag-excellent { color: #52c41a; background-color: #f6ffed; border-color: #b7eb8f; }

        .choice-container { display: flex; gap: 10px; margin: 10px 0; }
        .chat-choice-btn { padding: 10px 20px; border-radius: 18px; border: 2px solid var(--ac-mint); background: white; color: var(--ac-mint); cursor: pointer; font-weight: bold; }
        #modal-overlay { display: none; position: fixed; inset: 0; z-index: 3000; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(15px); justify-content: center; align-items: center; }
        .modal-card { width: 92%; max-width: 850px; height: 85vh; background: white; border-radius: 45px; border: 6px solid var(--ac-mint); overflow: hidden; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="shiba-container">
            <img id="achai-img" src="shiba.png" class="shiba-idle" alt="阿柴">
        </div>
        <div id="chat-window">
            <div class="msg bot">你好汪！我是你的助手阿柴。测评完成后我会为你生成专属的分析报告。准备好了吗？</div>
        </div>
        <div id="typing-indicator" class="typing-bubble">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="和阿柴说点什么..." onfocus="changeShibaState('focus')" onblur="handleInputBlur()" onkeydown="if(event.key==='Enter') handleUserInput()">
            <button onclick="handleUserInput()" style="background:var(--ac-mint); color:white; border:none; padding:12px 25px; border-radius:15px; cursor:pointer; font-weight:bold;">发送</button>
        </div>
    </div>

    <div id="modal-overlay"><div class="modal-card"><iframe id="exp-iframe" style="width:100%; height:100%; border:none;" src=""></iframe></div></div>

    <div id="report-overlay">
        <div class="report-content">
            <div class="score-card">
                <div class="score-big" id="res-total-score">0</div>
                <div class="score-label" id="res-severity">状态加载中</div>
                <p id="res-intro" style="font-size: 13px; color: #666; margin-top: 15px; line-height: 1.6;">下方心理地图与指南已根据你的数据生成</p>
            </div>
            <div class="tabs">
                <div id="tab-cognitive" class="tab active" onclick="switchTab('cognitive')">认知</div>
                <div id="tab-behavioral" class="tab" onclick="switchTab('behavioral')">行为</div>
                <div id="tab-emotional" class="tab" onclick="switchTab('emotional')">情绪</div>
                <div id="tab-social" class="tab" onclick="switchTab('social')">社会</div>
            </div>
            <div class="chart-container">
                <div id="radar-view" class="radar-wrapper">
                    <div id="dim-0" class="dim-label pos-0"><span>-</span><span class="level-tag">-</span></div>
                    <div id="dim-1" class="dim-label pos-1"><span>-</span><span class="level-tag">-</span></div>
                    <div id="dim-2" class="dim-label pos-2"><span>-</span><span class="level-tag">-</span></div>
                    <svg width="220" height="220" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="12.5" class="grid-circle" stroke-dasharray="2,2" />
                        <circle cx="50" cy="50" r="25" class="grid-circle" />
                        <circle cx="50" cy="50" r="37.5" class="grid-circle" />
                        <circle cx="50" cy="50" r="50" class="grid-circle" />
                        <g id="axes" stroke="#f5f5f5" stroke-width="1"></g>
                        <polygon id="data-poly" points="" class="data-area" />
                        <g id="data-dots"></g>
                    </svg>
                </div>
                <div id="progress-view" class="progress-wrapper">
                    <div class="prog-item">
                        <svg class="prog-svg"><circle class="prog-bg" cx="50" cy="50" r="40"/><circle id="circ-0" class="prog-bar" cx="50" cy="50" r="40" stroke-dasharray="251.2" stroke-dashoffset="251.2"/></svg>
                        <div id="prog-val-0" class="prog-val">0%</div>
                        <div id="prog-name-0" class="prog-name">-</div>
                        <span id="prog-tag-0" class="level-tag">-</span>
                    </div>
                    <div class="prog-item">
                        <svg class="prog-svg"><circle class="prog-bg" cx="50" cy="50" r="40"/><circle id="circ-1" class="prog-bar" cx="50" cy="50" r="40" stroke-dasharray="251.2" stroke-dashoffset="251.2"/></svg>
                        <div id="prog-val-1" class="prog-val">0%</div>
                        <div id="prog-name-1" class="prog-name">-</div>
                        <span id="prog-tag-1" class="level-tag">-</span>
                    </div>
                </div>
            </div>
            <div class="info-card">
                <div class="card-header">维度解析</div>
                <div id="res-analysis" style="font-size: 13px; color: #666; line-height: 1.6;">点击页签查看分析</div>
            </div>
            <div class="info-card">
                <div class="card-header">成长指南</div>
                <div id="res-guide"></div>
            </div>
            <button onclick="location.reload()" style="width:100%; margin-bottom: 50px; padding:18px; background:var(--ac-mint); color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;">完成并返回</button>
        </div>
    </div>

    <script>
        const API_KEY = 'app-RCkkrExdukn5sF6s41I8kxTz';
        const BASE_URL = 'https://ai.mindparse.cn/v1';
        const SHIBA_EXPRESSIONS = { idle: 'shiba.png', focus: 'shiba_focus.png', thinking: 'shiba_thinking.png', happy: 'shiba_happy.png' };
        let conversationId = ""; let userScores = {};

        function changeShibaState(state) {
            const img = document.getElementById('achai-img'); img.classList.add('shiba-fading');
            setTimeout(() => { img.src = SHIBA_EXPRESSIONS[state] || SHIBA_EXPRESSIONS.idle; img.classList.remove('shiba-fading'); state === 'idle' ? img.classList.add('shiba-idle') : img.classList.remove('shiba-idle'); }, 200);
        }
        function handleInputBlur() { if(document.getElementById('user-input').value === "") changeShibaState('idle'); }

        async function handleUserInput() {
            const inputEl = document.getElementById('user-input'); const text = inputEl.value.trim(); if (!text) return;
            appendMessage('user', text); inputEl.value = ""; changeShibaState('thinking'); await sendMessageToDify(text);
        }

        async function sendMessageToDify(query, isHidden = false) {
            if(!isHidden) document.getElementById('typing-indicator').style.display = 'block';
            try {
                const response = await fetch(`${BASE_URL}/chat-messages`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputs: {}, query: query, response_mode: "blocking", user: "tester_001", conversation_id: conversationId })
                });
                const data = await response.json(); conversationId = data.conversation_id; document.getElementById('typing-indicator').style.display = 'none';
                const answer = data.answer; changeShibaState('happy');
                if (answer.includes('[REPORT_DATA]')) { renderReport(answer.match(/\[REPORT_DATA\]\s*(.*)/)[1]); return; }
                appendMessage('bot', answer.replace(/\[EID:\s*(\w+)\]/g, "").trim());
                if (answer.includes('[EID:')) { const match = answer.match(/\[EID:\s*(\w+)\]/); if (match) appendChoiceButtons(match[1]); }
                setTimeout(() => changeShibaState('idle'), 3000);
            } catch (e) { document.getElementById('typing-indicator').style.display = 'none'; changeShibaState('idle'); }
        }

        function renderReport(dataStr) {
            try {
                const raw = JSON.parse(dataStr.match(/\{.*\}/)[0].replace(/\\"/g, '"'));
                userScores = { ...raw };
                
                // --- 核心修复：反向计分逻辑 (假设原始分最大为3) ---
                // d7(韧性)、d8(人际)、d9(学习) 均进行反向转换，变为“健康分”
                if(raw.d7 !== undefined) userScores.d7 = Math.max(0, 3 - parseFloat(raw.d7)); 
                if(raw.d8 !== undefined) userScores.d8 = Math.max(0, 3 - parseFloat(raw.d8)); 
                if(raw.d9 !== undefined) userScores.d9 = Math.max(0, 3 - parseFloat(raw.d9)); 

                // 总分依然基于原始问题得分判定
                const totalRaw = Object.values(raw).reduce((a, b) => a + (parseFloat(b) || 0), 0);
                document.getElementById('res-total-score').innerText = totalRaw.toFixed(1);
                const sev = document.getElementById('res-severity');
                sev.innerText = totalRaw >= 15 ? "需多关注" : "状态良好";
                sev.style.background = totalRaw >= 15 ? "#FFB37E" : "#88c0a7";
                document.getElementById('report-overlay').style.display = 'block';
                switchTab('cognitive');
            } catch (e) { console.error(e); }
        }

        function switchTab(dimKey) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${dimKey}`).classList.add('active');

            const getMetricsData = (name, s) => {
                const val = parseFloat(s) || 0; 
                const negativeMetrics = ["自伤", "抑郁", "压力"];
                
                if (negativeMetrics.includes(name)) {
                    // 负向指标处理：0最健康，3最严重
                    if (val === 0) return { name: name, text: "无", type: "excellent", radar: 4 };
                    if (val <= 1) return { name: name, text: "有点", type: "good", radar: 2.5 };
                    return { name: name, text: "关注", type: "concern", radar: 1 };
                } else {
                    // 正向/反向转换后指标处理：3最健康，0最严重
                    // --- 核心修复：线性映射 radar 值，映射 0-3 分到 1.0-4.0 尺度 ---
                    const radarVal = 1 + (val / 3) * 3; 
                    let type = "concern", text = "关注";
                    if (val >= 2.5) { type = "excellent"; text = "优秀"; }
                    else if (val >= 1.8) { type = "good"; text = "良好"; }
                    
                    return { name: name, text: text, type: type, radar: radarVal };
                }
            };

            const contentMap = {
                cognitive: { concern: { desc: "专注力容易分散，在复杂任务中较难保持持久的注意力。", guides: ["• 练习冥想提升觉察力", "• 减少多任务并行"] }, good: { desc: "认知表现尚可，但在处理高强度信息时仍有优化空间。", guides: ["• 尝试番茄工作法", "• 减少视觉干扰"] }, excellent: { desc: "专注力表现极佳，能在高难度任务中迅速进入深度思考。", guides: ["• 尝试挑战创造性工作", "• 保持每日阅读"] } },
                behavioral: { concern: { desc: "当前生活状态需要引起重视，建议及时调整作息与兴趣培养。", guides: ["• 设定严格熄灯时间", "• 记录每日活动"] }, good: { desc: "日常习惯基本稳定，建议继续优化作息深度，培养长期爱好。", guides: ["• 睡前远离电子屏幕", "• 增加户外活动"] }, excellent: { desc: "生活作息非常自律，保持了良好的身心活力。", guides: ["• 培养长期体育爱好", "• 坚持好的习惯"] } },
                emotional: { concern: { desc: "当前情绪压力较大，可能感到有些吃力，需注意心理放松。", guides: ["• 尝试腹式呼吸法", "• 找信任的朋友倾诉"] }, good: { desc: "情绪状态基本平稳，能够应对日常压力。", guides: ["• 学习情绪命名法", "• 建立压力解压清单"] }, excellent: { desc: "心态积极乐观，具备极佳的情绪调节能力。", guides: ["• 记录每日感恩日记", "• 保持积极引导作用"] } },
                social: { concern: { desc: "社交或学习方面感到些许阻碍，可能存在沟通不畅或动力不足。", guides: ["• 从简单的倾听开始", "• 参加小型兴趣小组"] }, good: { desc: "人际关系较为和谐，能够较好地适应校园生活。", guides: ["• 学习主动发起话题", "• 尝试团队沟通职责"] }, excellent: { desc: "社交能力强，人际互动顺畅，能维护高质量关系。", guides: ["• 提升深度沟通能力", "• 积极参与社团活动"] } }
            };

            const dimConfigs = {
                cognitive: [getMetricsData("专注力", userScores.d5), getMetricsData("冲动抑制", userScores.d6), getMetricsData("韧性", userScores.d7)],
                behavioral: [getMetricsData("睡眠", userScores.d4), getMetricsData("兴趣", userScores.d1), getMetricsData("自伤", userScores.d10)],
                emotional: [getMetricsData("抑郁", userScores.d2), getMetricsData("压力", userScores.d3)],
                social: [getMetricsData("人际", userScores.d8), getMetricsData("学习", userScores.d9)]
            };

            const items = dimConfigs[dimKey];
            const status = items[0].type;
            document.getElementById('res-analysis').innerText = contentMap[dimKey][status].desc;
            document.getElementById('res-guide').innerHTML = contentMap[dimKey][status].guides.map(g => `<div style="font-size:13px; color:#666; margin-bottom:5px;">${g}</div>`).join('');

            const radarView = document.getElementById('radar-view'); const progressView = document.getElementById('progress-view');
            if (items.length === 3) { radarView.style.display = "block"; progressView.style.display = "none"; renderRadar(items); }
            else { radarView.style.display = "none"; progressView.style.display = "flex"; renderProgress(items); }
        }

        function renderRadar(items) {
            const getCoord = (i, s) => ({ x: 50 + s * 12.5 * Math.cos((i * 120 - 90) * Math.PI / 180), y: 50 + s * 12.5 * Math.sin((i * 120 - 90) * Math.PI / 180) });
            let pts = [], dots = "", axes = "";
            items.forEach((it, i) => {
                const el = document.getElementById(`dim-${i}`); el.querySelector('span').innerText = it.name; 
                el.querySelector('.level-tag').innerText = it.text; el.querySelector('.level-tag').className = `level-tag tag-${it.type}`;
                const c = getCoord(i, it.radar); pts.push(`${c.x},${c.y}`); dots += `<circle cx="${c.x}" cy="${c.y}" r="3.5" class="data-point" />`;
                const a = getCoord(i, 4); axes += `<line x1="50" y1="50" x2="${a.x}" y2="${a.y}" />`;
            });
            document.getElementById('data-poly').setAttribute('points', pts.join(' ')); document.getElementById('data-dots').innerHTML = dots; document.getElementById('axes').innerHTML = axes;
        }

        function renderProgress(items) {
            const colors = { excellent: "#52c41a", good: "#1890ff", concern: "#ff4d4f" };
            items.forEach((it, i) => {
                // 进度计算保持逻辑一致：radar 4.0 = 100%, radar 1.0 = 25%
                const percent = (it.radar / 4) * 100; 
                const offset = 251.2 - (251.2 * (percent / 100));
                const circ = document.getElementById(`circ-${i}`); circ.style.strokeDashoffset = offset; circ.style.stroke = colors[it.type];
                document.getElementById(`prog-val-${i}`).innerText = Math.round(percent) + "%";
                document.getElementById(`prog-val-${i}`).style.color = colors[it.type];
                document.getElementById(`prog-name-${i}`).innerText = it.name;
                const tag = document.getElementById(`prog-tag-${i}`); tag.innerText = it.text; tag.className = `level-tag tag-${it.type}`;
            });
        }

        function appendMessage(role, text) { const chat = document.getElementById('chat-window'); const div = document.createElement('div'); div.className = `msg ${role}`; div.innerText = text; chat.appendChild(div); chat.scrollTop = chat.scrollHeight; }
        function appendChoiceButtons(eid) { const chat = document.getElementById('chat-window'); const container = document.createElement('div'); container.className = 'choice-container'; container.innerHTML = `<button class="chat-choice-btn" onclick="openExp('${eid}', this)">立即开始</button><button class="chat-choice-btn" style="border-color:#CCC; color:#999;" onclick="this.parentElement.remove(); sendMessageToDify('暂时跳过', true)">暂不需要</button>`; chat.appendChild(container); chat.scrollTop = chat.scrollHeight; }
        function openExp(eid, btn) { btn.parentElement.remove(); document.getElementById('modal-overlay').style.display='flex'; document.getElementById('exp-iframe').src=`experiments/${eid}.html`; }
        window.addEventListener('message', (e) => { if(e.data && e.data.type === 'experiment_result') { document.getElementById('modal-overlay').style.display='none'; sendMessageToDify(`[EXP_DATA] score:${e.data.score}`, true); } });
    </script>
</body>
</html>