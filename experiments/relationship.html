<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-12 äººé™…å…³ç³»å°å²› - ä¼˜åŒ–ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ac-mint: #a7e4d1;
            --ac-sky: #b6e3f4;
            --ac-cream: #fbf8e8;
            --ac-sand: #e8dcb5;
            --ac-coral: #ff8a80;
            --ac-blue: #82ccdd;
            --apple-blur: blur(20px);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --soft-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            --text-primary: #333;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            margin: 0; padding: 10px;
            background: linear-gradient(135deg, var(--ac-mint) 0%, var(--ac-sky) 100%);
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-primary);
            overflow-y: auto; /* å…è®¸çºµå‘æ»šåŠ¨ä»¥é˜²ä¸‡ä¸€ */
        }

        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: var(--apple-blur);
            -webkit-backdrop-filter: var(--apple-blur);
            border-radius: 30px;
            border: var(--glass-border);
            box-shadow: var(--soft-shadow);
            padding: 20px 30px; /* å‹ç¼©ä¸Šä¸‹å†…è¾¹è· */
            display: flex; flex-direction: column; align-items: center;
            max-width: 800px; width: 95%;
            position: relative;
        }

        h2 { color: #57606f; margin: 0 0 5px 0; font-size: 1.5rem; }
        p.instruction { text-align: center; color: #747d8c; margin: 0 0 15px 0; font-size: 0.9rem; line-height: 1.2; }

        .experiment-layout {
            display: flex; gap: 30px; align-items: center; justify-content: center; width: 100%;
        }

        /* é¶å¿ƒåŒºåŸŸï¼šä»450pxç¼©å°è‡³360px */
        #island-map {
            position: relative;
            width: 360px; height: 360px;
            background: radial-gradient(circle, var(--ac-cream) 0%, var(--ac-sand) 100%);
            border-radius: 50%;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.05), 0 5px 15px rgba(0,0,0,0.1);
            border: 4px solid rgba(255,255,255,0.5);
            flex-shrink: 0;
        }

        /* é‡æ–°è®¡ç®—æ¶Ÿæ¼ªå°ºå¯¸ */
        .ripple {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; border: 1.5px dashed rgba(164, 176, 190, 0.3);
            pointer-events: none;
        }
        .ripple-3 { width: 120px; height: 120px; background: rgba(255, 138, 128, 0.05); }
        .ripple-2 { width: 240px; height: 240px; background: rgba(130, 204, 221, 0.05); }
        .ripple-1 { width: 360px; height: 360px; }

        #center-avatar {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px;
            background: var(--ac-coral); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; z-index: 10;
            border: 3px solid white; box-shadow: 0 4px 10px rgba(255, 138, 128, 0.3);
        }

        /* ä¾§è¾¹æ ï¼šå¾®è°ƒä½ç½® */
        .sidebar { display: flex; flex-direction: column; gap: 12px; padding: 15px; background: rgba(255,255,255,0.3); border-radius: 20px; }

        .token {
            width: 65px; height: 65px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: grab; font-weight: 700; font-size: 13px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid rgba(255,255,255,0.8);
            user-select: none;
        }
        .token:active { cursor: grabbing; transform: scale(0.95); }

        .token[data-type="çˆ¶æ¯"] { background: linear-gradient(135deg, #ff9f43, #ff6b6b); }
        .token[data-type="è€å¸ˆ"] { background: linear-gradient(135deg, #54a0ff, #2e86de); }
        .token[data-type="åŒå­¦"] { background: linear-gradient(135deg, #1dd1a1, #10ac84); }
        .token[data-type="æœ‹å‹"] { background: linear-gradient(135deg, #feca57, #ff9f43); }

        .finish-btn {
            margin-top: 20px; padding: 12px 50px;
            background: var(--ac-blue); color: white;
            border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 6px 15px rgba(130, 204, 221, 0.3);
            transition: all 0.2s ease;
        }
        .finish-btn:hover { background: #6bb9ca; transform: translateY(-2px); }

        #complete-screen {
            position: absolute; inset: 0; background: var(--glass-bg);
            backdrop-filter: var(--apple-blur); border-radius: 30px;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; text-align: center;
        }
    </style>
</head>
<body>

    <div class="glass-container" id="main-ui">
        <h2>æˆ‘çš„ç¤¾äº¤å°å²›</h2>
        <p class="instruction">è¯·å°†ä¼™ä¼´æ‹–åˆ°å²›ä¸Šã€‚ç¦»â€œæˆ‘â€è¶Šè¿‘ï¼Œä»£è¡¨å…³ç³»è¶Šäº²å¯†å“¦ï¼</p>

        <div class="experiment-layout">
            <div id="island-map">
                <div id="center-avatar">æˆ‘</div>
                <div class="ripple ripple-1"></div>
                <div class="ripple ripple-2"></div>
                <div class="ripple ripple-3"></div>
            </div>

            <div class="sidebar" id="token-sidebar">
                <div class="token" id="parents" data-type="çˆ¶æ¯">çˆ¶æ¯</div>
                <div class="token" id="teacher" data-type="è€å¸ˆ">è€å¸ˆ</div>
                <div class="token" id="classmate" data-type="åŒå­¦">åŒå­¦</div>
                <div class="token" id="friend" data-type="æœ‹å‹">æœ‹å‹</div>
            </div>
        </div>

        <button class="finish-btn" onclick="calculateOverallScore()">ç¡®è®¤å¹¶æäº¤</button>

        <div id="complete-screen">
            <div style="font-size: 50px; margin-bottom: 20px;">ğŸï¸</div>
            <h2 style="color: var(--ac-blue);">å¸ƒç½®å®Œæˆï¼</h2>
            <p style="color: #747d8c;">ä¼™ä¼´ä»¬å·²ç»åœ¨ä½ çš„å°å²›è½åº§äº†ã€‚<br>æ­£åœ¨å›ä¼ æ•°æ®è‡³åŠ©æ‰‹é˜¿æŸ´...</p>
        </div>
    </div>

    <script>
        const tokens = document.querySelectorAll('.token');
        const islandMap = document.getElementById('island-map');
        const completeScreen = document.getElementById('complete-screen');
        let zIndexCounter = 100;

        // æ‹–æ‹½é€»è¾‘é€‚é…ç¼©å°åçš„åœ°å›¾
        tokens.forEach(token => {
            token.onmousedown = function(event) {
                token.style.zIndex = ++zIndexCounter;
                let shiftX = event.clientX - token.getBoundingClientRect().left;
                let shiftY = event.clientY - token.getBoundingClientRect().top;

                if (token.parentNode !== document.body) {
                    document.body.append(token);
                    token.style.position = 'absolute';
                }
                
                function moveAt(pageX, pageY) {
                    token.style.left = pageX - shiftX + 'px';
                    token.style.top = pageY - shiftY + 'px';
                }

                function onMouseMove(event) { moveAt(event.pageX, event.pageY); }
                document.addEventListener('mousemove', onMouseMove);

                token.onmouseup = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    token.onmouseup = null;
                };
            };
            token.ondragstart = function() { return false; };
        });

        function calculateOverallScore() {
            const mapRect = islandMap.getBoundingClientRect();
            const centerX = mapRect.left + mapRect.width / 2;
            const centerY = mapRect.top + mapRect.height / 2;
            const mapRadius = mapRect.width / 2;

            let totalScore = 0;
            let itemCount = 0;

            tokens.forEach(token => {
                itemCount++;
                const tokenRect = token.getBoundingClientRect();
                const tokenX = tokenRect.left + tokenRect.width / 2;
                const tokenY = tokenRect.top + tokenRect.height / 2;

                const distance = Math.sqrt(Math.pow(tokenX - centerX, 2) + Math.pow(tokenY - centerY, 2));
                
                let itemScore = 0;
                // æŒ‰æ¯”ä¾‹ç¼©æ”¾åçš„è®¡åˆ†é€»è¾‘ (åŸ450ç¼©è‡³360ï¼Œæ¯”ä¾‹çº¦ä¸º0.8)
                if (distance <= 60) itemScore = 3;      
                else if (distance <= 120) itemScore = 2; 
                else if (distance <= 180) itemScore = 1; 
                else if (distance <= mapRadius + 15) itemScore = 0.5;
                else itemScore = 0;

                totalScore += itemScore;
            });

            const finalAverageScore = parseFloat((totalScore / itemCount).toFixed(1));
            
            window.parent.postMessage({
                type: 'experiment_result',
                eid: 'relationship',
                score: finalAverageScore
            }, '*');

            tokens.forEach(t => t.style.display = 'none'); 
            completeScreen.style.display = 'flex';
        }
    </script>
</body>
</html>