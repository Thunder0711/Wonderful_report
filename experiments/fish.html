<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ·±æµ·é‡‘æªé±¼æŒ‘æˆ˜èµ› - æ ‡å‡†å®éªŒç‰ˆ</title>
    <style>
        body { background: #012d5e; font-family: 'å¹¼åœ†', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: white; overflow: hidden; user-select: none; }
        #game-screen { width: 700px; height: 500px; background: #0277bd; border: 6px solid #fff; border-radius: 30px; position: relative; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); overflow: hidden; }
        
        /* å¼•å¯¼é¡µ */
        #rule-screen { position: absolute; inset: 0; background: #01579b; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .rule-card { background: white; color: #01579b; padding: 25px; border-radius: 20px; margin-bottom: 25px; }
        .key-hint { display: inline-block; padding: 4px 12px; background: #e1f5fe; border: 2px solid #01579b; border-radius: 6px; font-weight: bold; }

        /* æ¸¸æˆåŒºåŸŸ */
        #status-bar { height: 60px; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: space-around; color: #01579b; font-weight: bold; font-size: 18px; z-index: 10; }
        #ocean { flex: 1; position: relative; background: radial-gradient(circle, #0288d1 0%, #01579b 100%); display: flex; align-items: center; justify-content: center; }
        #fish-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 5; }
        #fixation { font-size: 60px; color: white; font-weight: bold; display: none; }
        #feedback { position: absolute; top: 20px; font-size: 24px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 20; }

        /* é‡‘æªé±¼ SVG */
        .tuna-svg { width: 220px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); }
        
        /* ç»“æœå±•ç¤º */
        #result-screen { position: absolute; inset: 0; background: white; color: #01579b; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; padding: 20px; text-align: center; }
        .btn-main { padding: 14px 45px; background: #ffc107; color: #3e2723; border: none; border-radius: 50px; cursor: pointer; font-size: 22px; font-weight: bold; box-shadow: 0 5px 0 #ffa000; }
    </style>
</head>
<body>

    <div id="game-screen">
        <div id="rule-screen">
            <h1 style="color: #ffeb3b; margin-bottom: 15px;">ğŸŒŠ æ¬¢è¿æ¥åˆ°ï¼šæ·±æµ·é’“é±¼å¤§æ¯”æ‹¼ï¼</h1>
            <div class="rule-card">
                <p style="font-size: 19px; margin: 10px 0;">æ¢é™©å®¶ï¼Œæµ·é¢ä¸‹æ­£æ¸¸åŠ¨ç€ä¸€ç¾¤<b>é‡‘æªé±¼</b>ï¼</p>
                <p>è¯·è§‚å¯Ÿå®ƒä»¬çš„<b>èƒŒé³é•¿åº¦</b>ï¼Œå¿«é€Ÿåšå‡ºååº”ï¼š</p>
                <div style="margin: 20px 0; font-size: 20px;">
                    <span class="key-hint">F é”®</span> é’“ <b>çŸ­é³</b> é‡‘æªé±¼ <br><br>
                    <span class="key-hint">J é”®</span> é’“ <b>é•¿é³</b> é‡‘æªé±¼
                </div>
                <p style="color: #666; font-size: 14px;">(æ­£å¼å¼€å§‹å‰ï¼Œå°†è¿›è¡Œ 3 æ¬¡ç»ƒä¹ ç¯èŠ‚)</p>
            </div>
            <button class="btn-main" onclick="startGame()">å¼€å§‹ç»ƒä¹ ï¼</button>
        </div>

        <div id="status-bar">
            <div id="trial-label">è¿›åº¦: <span id="trial-count">0</span> / 20</div>
            <div>é‡‘å¸: ğŸ’°<span id="gold-count">0</span></div>
        </div>

        <div id="ocean">
            <div id="feedback"></div>
            <div id="fixation">+</div>
            <div id="fish-container">
                <svg class="tuna-svg" viewBox="0 0 240 140">
                    <path fill="#0277bd" d="M180 70 L220 30 L220 110 Z" stroke="#fff" stroke-width="2"/>
                    <path fill="#01579b" d="M15,75 Q15,25 100,25 T185,75 T100,125 T15,75" stroke="#fff" stroke-width="3"/>
                    <ellipse fill="#4fc3f7" cx="100" cy="92" rx="60" ry="25" opacity="0.4"/>
                    <circle fill="white" cx="55" cy="65" r="11"/>
                    <circle fill="black" cx="57" cy="65" r="5" />
                    <path id="fin-path" fill="#039be5" stroke="#fff" stroke-width="2" d="" />
                </svg>
            </div>
        </div>

        <div id="result-screen">
            <h2>ğŸ† æ•é±¼ç»“æœæŠ¥å‘Š</h2>
            <p>åŸºäºæ‚¨çš„å†³ç­–è¡Œä¸ºï¼Œååº”åå·®ä¸ºï¼š</p>
            <div id="bias-val" style="font-size: 56px; color: #d32f2f; font-weight: bold; margin: 15px 0;">0.00</div>
            <p id="bias-desc" style="max-width: 480px; color: #455a64; line-height: 1.6;"></p>
            <button class="btn-main" onclick="location.reload()">é‡æ–°æµ‹è¯„</button>
        </div>
    </div>

    <script>
        const TOTAL_TRIALS = 20;
        const PRACTICE_TRIALS = 3;    // æ–°å¢ï¼šç»ƒä¹ æ¬¡æ•°
        const PRESENT_TIME = 100;    
        const RESPONSE_WINDOW = 1750; 
        
        let trialIdx = 0;
        let totalGold = 0;
        let isWaitingInput = false;
        let currentFishSize = '';
        let responseTimer = null;
        let isPractice = true;        // æ–°å¢ï¼šæ˜¯å¦å¤„äºç»ƒä¹ çŠ¶æ€

        let stats = { Lc: 0, Li: 0, Sc: 0, Si: 0 };

        const FIN_SHORT = "M80 30 Q110 8 140 30 L130 40 Q110 32 80 40 Z";
        const FIN_LONG = "M80 30 Q110 -15 145 30 L130 40 Q110 32 80 40 Z";

        function startGame() {
            document.getElementById('rule-screen').style.display = 'none';
            runTrial();
        }

        function runTrial() {
            // æ£€æŸ¥æ­£å¼å®éªŒæ˜¯å¦ç»“æŸ
            if (!isPractice && trialIdx >= TOTAL_TRIALS) return showResult();

            // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤º
            if (isPractice) {
                document.getElementById('trial-label').innerHTML = `ç»ƒä¹ ç¯èŠ‚: <span id="trial-count">${trialIdx + 1}</span> / ${PRACTICE_TRIALS}`;
            } else {
                document.getElementById('trial-label').innerHTML = `æ­£å¼è¿›åº¦: <span id="trial-count">${trialIdx}</span> / ${TOTAL_TRIALS}`;
            }

            document.getElementById('feedback').innerText = "";
            document.getElementById('fixation').style.display = 'block';
            document.getElementById('fish-container').style.display = 'none';

            setTimeout(() => {
                document.getElementById('fixation').style.display = 'none';
                flashFish();
            }, 500);
        }

        function flashFish() {
            currentFishSize = Math.random() > 0.5 ? 'long' : 'short';
            document.getElementById('fin-path').setAttribute('d', currentFishSize === 'long' ? FIN_LONG : FIN_SHORT);
            
            const fish = document.getElementById('fish-container');
            fish.style.display = 'block';

            setTimeout(() => {
                fish.style.display = 'none';
            }, PRESENT_TIME);

            isWaitingInput = true;

            responseTimer = setTimeout(() => {
                if (isWaitingInput) {
                    isWaitingInput = false;
                    document.getElementById('feedback').innerText = "å“å‘€ï¼Œé”™è¿‡äº†ï¼";
                    document.getElementById('feedback').style.color = "#ccc";
                    finishTrial(null);
                }
            }, RESPONSE_WINDOW);
        }

        window.addEventListener('keydown', (e) => {
            if (!isWaitingInput) return;
            const key = e.key.toLowerCase();
            if (key !== 'f' && key !== 'j') return;

            clearTimeout(responseTimer);
            isWaitingInput = false;

            const choice = (key === 'j') ? 'long' : 'short';
            finishTrial(choice);
        });

        function finishTrial(choice) {
            if (choice) {
                const correct = (choice === currentFishSize);
                
                // åªæœ‰æ­£å¼å®éªŒæ‰è®°å½•æ•°æ®
                if (!isPractice) {
                    if (currentFishSize === 'long') {
                        correct ? stats.Lc++ : stats.Li++;
                    } else {
                        correct ? stats.Sc++ : stats.Si++;
                    }
                }

                let winProb = (currentFishSize === 'long') ? 1 : 0;
                if (correct && Math.random() < winProb) {
                    totalGold += 30;
                    document.getElementById('gold-count').innerText = totalGold;
                    document.getElementById('feedback').innerText = isPractice ? "ç»ƒä¹ æ­£ç¡®ï¼é‡‘å¸ +30" : "âœ¨ å®Œç¾ï¼é‡‘å¸ +30 âœ¨";
                    document.getElementById('feedback').style.color = "#ffeb3b";
                } else if (correct) {
                    totalGold += 10;
                    document.getElementById('gold-count').innerText = totalGold;
                    document.getElementById('feedback').innerText = isPractice ? "ç»ƒä¹ æ­£ç¡®ï¼é‡‘å¸ +10" : "é‡‘å¸ + 10";
                    document.getElementById('feedback').style.color = "white";
                } else {
                    document.getElementById('feedback').innerText = "å“å‘€ï¼Œçœ‹é”™äº†";
                    document.getElementById('feedback').style.color = "#ff8a80";
                }
            }

            trialIdx++;

            // ç»ƒä¹ ç¯èŠ‚ç»“æŸåˆ¤æ–­
            if (isPractice && trialIdx >= PRACTICE_TRIALS) {
                isPractice = false;
                trialIdx = 0;
                totalGold = 0; // é‡ç½®ç»ƒä¹ é‡‘å¸
                setTimeout(() => {
                    alert("ç»ƒä¹ ç»“æŸï¼ç°åœ¨è¿›å…¥æ­£å¼ç¯èŠ‚ï¼ŒåŠ æ²¹å“¦ï¼");
                    document.getElementById('gold-count').innerText = 0;
                    runTrial();
                }, 1000);
            } else {
                setTimeout(runTrial, 1000);
            }
        }

        function showResult() {
            const Lc = stats.Lc + 0.5; 
            const Si = stats.Si + 0.5; 
            const Li = stats.Li + 0.5; 
            const Sc = stats.Sc + 0.5; 

            const logB = 0.5 * Math.log10((Lc * Si) / (Li * Sc));

            let phq9_score = 0;
            if (logB > 0.10) {
                phq9_score = 0;
            } else if (logB > 0.05) {
                phq9_score = 1;
            } else if (logB >= -0.05) {
                phq9_score = 2;
            } else {
                phq9_score = 3;
            }

            const payload = {
                type: "experiment_result",
                eid: "fish",
                score: phq9_score,
                raw_logB: logB.toFixed(3)
            };
            
            window.parent.postMessage(payload, "*");

            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('bias-val').innerText = logB.toFixed(3);
            document.getElementById('bias-desc').innerText = 
                `é’“é±¼å®éªŒç»“æŸï¼æ‚¨çš„å…´è¶£åå¥½è¯„ä¼°ä¸ºï¼š${phq9_score} åˆ†ã€‚æ•°æ®å·²è‡ªåŠ¨åŒæ­¥è‡³æµ‹è¯„ç³»ç»Ÿã€‚`;
        }
    </script>
</body>
</html>