<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --ac-mint: #A8D5BA; --ac-cream: #FDFaf5; --ac-brown: #5B4636;
            --ac-sand: #E6D5B8; --accent-blue: #78A2CC; --light-blue: #D0E1F0;
        }
        body {
            font-family: -apple-system, sans-serif; background-color: #fff;
            display: flex; flex-direction: column; align-items: center;
            padding: 5px; margin: 0; color: var(--ac-brown); overflow-x: hidden;
        }

        .header { text-align: center; margin-bottom: 5px; }
        .header h2 { margin: 0; font-size: 1.1rem; }
        .header p { margin: 2px 0; font-size: 0.75rem; color: #999; }

        /* ä¼˜åŒ–æ‹¨ç›˜å°ºå¯¸ä»340pxç¼©å°è‡³280px */
        #sleep-dial {
            position: relative; width: 280px; height: 280px; margin: 5px auto;
            touch-action: none; user-select: none;
        }

        .clock-label {
            position: absolute; font-size: 10px; color: #CCC;
            transform: translate(-50%, -50%); pointer-events: none;
        }

        .dial-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .dial-track { fill: none; stroke: #EBE6D9; stroke-width: 20; }
        .range-bed { fill: none; stroke: var(--light-blue); stroke-width: 20; stroke-linecap: round; }
        .range-sleep { fill: none; stroke: var(--accent-blue); stroke-width: 20; stroke-linecap: round; }

        .handle-wrapper { position: absolute; width: 38px; height: 38px; z-index: 10; }
        .handle {
            width: 100%; height: 100%; background: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: grab; font-size: 18px;
        }
        
        .time-bubble {
            position: absolute; top: -32px; left: 50%; transform: translateX(-50%);
            background: #5D574F; color: white; padding: 2px 6px;
            border-radius: 6px; font-size: 10px; font-weight: bold; white-space: nowrap;
            opacity: 0; transition: opacity 0.2s;
        }
        .handle-wrapper:hover .time-bubble, .handle-wrapper.active .time-bubble { opacity: 1; }

        .frequency-section { width: 95%; margin-top: 5px; }
        .freq-title { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #5D574F; }
        .freq-buttons { display: flex; justify-content: space-between; gap: 5px; }
        .freq-btn {
            flex: 1; padding: 8px; border: 1px solid #EEE;
            background: #FDFCF8; border-radius: 10px; cursor: pointer; font-size: 0.8rem; color: #5D574F;
        }
        .freq-btn.active { background: #FFB37E; color: white; border-color: #FFB37E; font-weight: bold; }

        .stats-row {
            margin-top: 10px; width: 95%; background: #FDFCF8;
            border-radius: 15px; padding: 10px; display: grid;
            grid-template-columns: repeat(2, 1fr); gap: 10px; border: 1px solid #F0EDE5;
        }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.7rem; color: #AAA; }
        .stat-val { font-size: 0.95rem; font-weight: bold; color: var(--accent-blue); }

        .submit-btn {
            margin-top: 10px; background: #5D574F; color: white;
            border: none; width: 95%; padding: 12px; border-radius: 12px; 
            cursor: pointer; font-size: 0.95rem; font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>ç¡çœ è´¨é‡è¯„ä¼°</h2>
        <p>è°ƒæ•´å›¾æ ‡ï¼Œåé¦ˆçœŸå®çš„å…¥ç¡ä¸æ¸…é†’æƒ…å†µ</p>
    </div>

    <div id="sleep-dial">
        <div id="clock-labels"></div>
        <svg class="dial-svg" viewBox="0 0 200 200">
            <circle class="dial-track" cx="100" cy="100" r="85" />
            <path id="path-bed" class="range-bed" d="" />
            <path id="path-sleep" class="range-sleep" d="" />
        </svg>

        <div id="wrap-bed" class="handle-wrapper">
            <div class="time-bubble" id="label-bed">ä¸ŠåºŠ 21:00</div>
            <div class="handle">ğŸ›ï¸</div>
        </div>
        <div id="wrap-sleep" class="handle-wrapper">
            <div class="time-bubble" id="label-sleep">å…¥ç¡ 23:00</div>
            <div class="handle">ğŸŒ™</div>
        </div>
        <div id="wrap-wake" class="handle-wrapper">
            <div class="time-bubble" id="label-wake">èµ·åºŠ 07:00</div>
            <div class="handle">â˜€ï¸</div>
        </div>
    </div>

    <div class="frequency-section">
        <div class="freq-title">ä¸­é€”é†’æ¥çš„é¢‘ç‡ï¼ˆæ¬¡æ•°ï¼‰</div>
        <div class="freq-buttons">
            <button class="freq-btn active" onclick="setFreq(0, this)">0æ¬¡</button>
            <button class="freq-btn" onclick="setFreq(1, this)">1-2æ¬¡</button>
            <button class="freq-btn" onclick="setFreq(2, this)">3-4æ¬¡</button>
            <button class="freq-btn" onclick="setFreq(3, this)">5æ¬¡+</button>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-item"><span class="stat-label">èººåºŠæ—¶é•¿</span><span id="v-bed" class="stat-val">10.0h</span></div>
        <div class="stat-item"><span class="stat-label">å®é™…ç¡çœ </span><span id="v-sleep" class="stat-val">8.0h</span></div>
        <div class="stat-item"><span class="stat-label">å…¥ç¡æ½œä¼</span><span id="v-latency" class="stat-val">120min</span></div>
        <div class="stat-item"><span class="stat-label">ç¡çœ æ•ˆç‡</span><span id="v-eff" class="stat-val">80%</span></div>
    </div>

    <button class="submit-btn" onclick="doSubmit()">æäº¤è¯„ä¼°ç»“æœ</button>

<script>
    let state = { bed: 315, sleep: 345, wake: 105, freq: 0 };
    const radius = 85;

    // åˆå§‹åŒ–24å°æ—¶åˆ¶åˆ»åº¦ - è°ƒæ•´åç§»é‡ä¸º140 (280/2)
    const labelContainer = document.getElementById('clock-labels');
    for (let i = 0; i < 24; i += 3) {
        const angle = (i * 15 - 90) * (Math.PI / 180);
        const x = 140 + 100 * Math.cos(angle); 
        const y = 140 + 100 * Math.sin(angle);
        const lbl = document.createElement('div');
        lbl.className = 'clock-label';
        lbl.style.left = x + 'px'; lbl.style.top = y + 'px';
        lbl.innerText = i + ':00';
        labelContainer.appendChild(lbl);
    }

    function formatTime(deg) {
        let totalMin = Math.round((deg % 360) * 4);
        let h = Math.floor(totalMin / 60) % 24;
        let m = Math.floor((totalMin % 60) / 15) * 15;
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
    }

    function updateUI() {
        const updatePos = (id, deg, bubbleId, name) => {
            const rad = (deg - 90) * (Math.PI / 180);
            const x = 140 + 78 * Math.cos(rad); // ç¼©å°æ—‹è½¬åŠå¾„é€‚é…å®¹å™¨
            const y = 140 + 78 * Math.sin(rad);
            const el = document.getElementById(id);
            el.style.left = `${x - 19}px`; el.style.top = `${y - 19}px`;
            document.getElementById(bubbleId).innerText = `${name} ${formatTime(deg)}`;
        };

        updatePos('wrap-bed', state.bed, 'label-bed', 'ä¸ŠåºŠ');
        updatePos('wrap-sleep', state.sleep, 'label-sleep', 'å…¥ç¡');
        updatePos('wrap-wake', state.wake, 'label-wake', 'èµ·åºŠ');

        const draw = (s, e, id) => {
            const sR = (s-90)*Math.PI/180, eR = (e-90)*Math.PI/180;
            const x1 = 100+85*Math.cos(sR), y1 = 100+85*Math.sin(sR);
            const x2 = 100+85*Math.cos(eR), y2 = 100+85*Math.sin(eR);
            const large = (e - s + 360) % 360 > 180 ? 1 : 0;
            document.getElementById(id).setAttribute('d', `M ${x1} ${y1} A 85 85 0 ${large} 1 ${x2} ${y2}`);
        };
        draw(state.bed, state.wake, 'path-bed');
        draw(state.sleep, state.wake, 'path-sleep');

        const bedMin = ((state.wake - state.bed + 360) % 360) * 4;
        const sleepMin = ((state.wake - state.sleep + 360) % 360) * 4;
        const latMin = ((state.sleep - state.bed + 360) % 360) * 4;
        const eff = bedMin > 0 ? (sleepMin / bedMin) : 0;

        document.getElementById('v-bed').innerText = (bedMin/60).toFixed(1) + 'h';
        document.getElementById('v-sleep').innerText = (sleepMin/60).toFixed(1) + 'h';
        document.getElementById('v-latency').innerText = latMin + 'min';
        document.getElementById('v-eff').innerText = Math.round(eff*100) + '%';

        let score = 0;
        if (eff < 0.65 || state.freq >= 3) score = 3;
        else if (eff < 0.75 || state.freq === 2 || latMin > 60) score = 2;
        else if (eff < 0.85 || state.freq === 1 || latMin > 30) score = 1;
        state.finalScore = score;
    }

    function setupDrag(id, key) {
        const el = document.getElementById(id);
        const move = (e) => {
            el.classList.add('active');
            const rect = document.getElementById('sleep-dial').getBoundingClientRect();
            const cx = rect.left + 140, cy = rect.top + 140; // é€‚é…280pxå°ºå¯¸
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let deg = Math.atan2(clientY - cy, clientX - cx) * 180 / Math.PI + 90;
            if (deg < 0) deg += 360;
            state[key] = Math.round(deg / 3.75) * 3.75;
            updateUI();
        };
        const stop = () => {
            el.classList.remove('active');
            document.onmousemove = null; document.ontouchmove = null;
        };
        el.onmousedown = () => { document.onmousemove = move; document.onmouseup = stop; };
        el.ontouchstart = (e) => { e.preventDefault(); document.ontouchmove = move; document.ontouchend = stop; };
    }

    function setFreq(v, btn) {
        state.freq = v;
        document.querySelectorAll('.freq-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateUI();
    }

    function doSubmit() {
        window.parent.postMessage({ type: 'experiment_result', eid: 'sleep', score: state.finalScore }, '*');
    }

    setupDrag('wrap-bed', 'bed'); setupDrag('wrap-sleep', 'sleep'); setupDrag('wrap-wake', 'wake');
    updateUI();
</script>
</body>
</html>