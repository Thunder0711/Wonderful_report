<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ·±æµ·ä¿æŠ¤è¡ŒåŠ¨ - æ ‡å‡† Go/No-Go æµ‹è¯„ç‰ˆ</title>
    <style>
        body { background: #012d5e; font-family: 'å¹¼åœ†', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: white; overflow: hidden; user-select: none; }
        #game-screen { width: 700px; height: 500px; background: #0277bd; border: 6px solid #fff; border-radius: 30px; position: relative; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); overflow: hidden; }
        
        /* å¼•å¯¼é¡µ */
        #rule-screen { position: absolute; inset: 0; background: #01579b; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .rule-card { background: white; color: #01579b; padding: 25px; border-radius: 20px; margin-bottom: 25px; }
        .key-hint { display: inline-block; padding: 4px 12px; background: #e1f5fe; border: 2px solid #01579b; border-radius: 6px; font-weight: bold; }

        /* æ¸¸æˆåŒºåŸŸ */
        #status-bar { height: 60px; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: space-around; color: #01579b; font-weight: bold; font-size: 18px; z-index: 10; }
        #ocean { flex: 1; position: relative; background: radial-gradient(circle, #0288d1 0%, #01579b 100%); display: flex; align-items: center; justify-content: center; }
        #fish-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 5; }
        #fixation { font-size: 60px; color: white; font-weight: bold; display: none; }
        #feedback { position: absolute; top: 20px; font-size: 26px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 20; }

        .fish-svg { width: 200px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); }
        
        /* ç»“æŸé¡µæ ·å¼ä¿®æ”¹ï¼šä¸å†æ˜¾ç¤ºå…·ä½“åˆ†æ•° */
        #finish-screen { position: absolute; inset: 0; background: #01579b; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; text-align: center; }
        .btn-main { padding: 14px 45px; background: #ffc107; color: #3e2723; border: none; border-radius: 50px; cursor: pointer; font-size: 22px; font-weight: bold; box-shadow: 0 5px 0 #ffa000; }
    </style>
</head>
<body>

    <div id="game-screen">
        <div id="rule-screen">
            <h1 style="color: #ffeb3b; margin-bottom: 15px;">ğŸ¡ ä¿æŠ¤æ²³è±š</h1>
            <div class="rule-card">
                <p style="font-size: 19px; margin: 10px 0;">æ¢é™©å®¶ï¼Œé’“é±¼è¿‡ç¨‹ä¹Ÿéœ€è¦å­¦ä¼šâ€œåˆ¹è½¦â€ï¼</p>
                <div style="margin: 20px 0; font-size: 20px; line-height: 2;">
                    çœ‹åˆ° <span style="color:#0277bd; font-weight:bold;">è“è‰²å°é±¼</span> æŒ‰ <span class="key-hint">F é”®</span> é’“èµ· <br>
                    çœ‹åˆ° <span style="color:#d32f2f; font-weight:bold;">çº¢è‰²æ²³è±š</span> <span style="color:#d32f2f; font-weight:bold;">ä¸¥ç¦æŒ‰é”®</span>
                </div>
                <p style="color: #666; font-size: 14px;">â€» è¯·å°½å¯èƒ½å¿«ä¸”å‡†ç¡®åœ°åšå‡ºååº”ã€‚</p>
            </div>
            <button class="btn-main" onclick="startGame()">å¼€å§‹æµ‹è¯„</button>
        </div>

        <div id="status-bar">
            <div>è¿›åº¦: <span id="trial-count">0</span> / 20</div>
            <div>é‡‘å¸: ğŸ’°<span id="gold-count">0</span></div>
        </div>

        <div id="ocean">
            <div id="feedback"></div>
            <div id="fixation">+</div>
            <div id="fish-container">
                <svg id="target-svg" class="fish-svg" viewBox="0 0 240 140"></svg>
            </div>
        </div>

        <div id="finish-screen">
            <h2 style="color: #ffeb3b;">æµ‹è¯„å·²å®Œæˆ</h2>
            <p style="font-size: 18px; margin-bottom: 30px;">æ­£åœ¨ä¸ºæ‚¨æ•´ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <script>
        const TOTAL_TRIALS = 20;
        const GO_PROB = 0.8;      // 80% è“é±¼ï¼ˆGo åˆºæ¿€ï¼‰
        const PRESENT_TIME = 600;  // ååº”çª—å£
        
        let trialIdx = 0;
        let totalGold = 0;
        let isWaitingInput = false;
        let currentFishType = ''; 
        let startTime = 0;
        let timer = null;

        let stats = {
            nogoError: 0,    // è¯¯ç‚¹æ²³è±šï¼ˆå†²åŠ¨ï¼‰
            nogoCorrect: 0,  // æŠ‘åˆ¶æˆåŠŸ
            rts: []
        };

        const BLUE_FISH_SVG = `
            <path fill="#0277bd" d="M180 70 L220 30 L220 110 Z" stroke="#fff" stroke-width="2"/>
            <path fill="#01579b" d="M15,75 Q15,25 100,25 T185,75 T100,125 T15,75" stroke="#fff" stroke-width="3"/>
            <circle fill="white" cx="55" cy="65" r="11"/><circle fill="black" cx="57" cy="65" r="5" />`;
        
        const RED_PUFFER_SVG = `
            <circle fill="#d32f2f" cx="100" cy="75" r="55" stroke="#fff" stroke-width="3"/>
            <path fill="#d32f2f" d="M100 15 L105 25 L95 25 Z M160 75 L150 70 L150 80 Z M40 75 L50 70 L50 80 Z M100 135 L105 125 L95 125 Z" stroke="#fff"/>
            <circle fill="white" cx="75" cy="60" r="12"/><circle fill="black" cx="78" cy="60" r="6" />
            <path d="M120 90 Q135 100 150 90" stroke="white" fill="none" stroke-width="3"/>`;

        function startGame() {
            document.getElementById('rule-screen').style.display = 'none';
            runTrial();
        }

        function runTrial() {
            if (trialIdx >= TOTAL_TRIALS) return showResult();

            clearTimeout(timer);
            document.getElementById('feedback').innerText = "";
            document.getElementById('fixation').style.display = 'block';
            document.getElementById('fish-container').style.display = 'none';

            // éšæœºå‘ˆç°é—´éš” (ISI)
            setTimeout(() => {
                document.getElementById('fixation').style.display = 'none';
                showFish();
            }, 600 + Math.random() * 600);
        }

        function showFish() {
            currentFishType = Math.random() < GO_PROB ? 'blue' : 'puffer';
            document.getElementById('target-svg').innerHTML = currentFishType === 'blue' ? BLUE_FISH_SVG : RED_PUFFER_SVG;
            document.getElementById('fish-container').style.display = 'block';
            
            isWaitingInput = true;
            startTime = Date.now();

            timer = setTimeout(() => {
                if (isWaitingInput) handleResponse(null); 
            }, PRESENT_TIME);
        }

        window.addEventListener('keydown', (e) => {
            if (!isWaitingInput) return;
            if (e.key.toLowerCase() !== 'f') return;
            
            clearTimeout(timer);
            handleResponse('f');
        });

        function handleResponse(key) {
            isWaitingInput = false;
            document.getElementById('fish-container').style.display = 'none';

            let feedbackText = "";
            let feedbackColor = "white";

            if (currentFishType === 'blue') {
                if (key === 'f') {
                    totalGold += 10;
                    feedbackText = "é’“åˆ°äº†ï¼+10é‡‘å¸";
                } else {
                    feedbackText = "é”™è¿‡è“é±¼";
                    feedbackColor = "#ff8a80";
                }
            } else { 
                if (key === 'f') {
                    stats.nogoError++; // å†²åŠ¨é”™è¯¯
                    totalGold = Math.max(0, totalGold - 30);
                    feedbackText = "è¯¯æ•ä¿æŠ¤é±¼ï¼-30é‡‘å¸";
                    feedbackColor = "#ff5252";
                } else {
                    stats.nogoCorrect++; // æŠ‘åˆ¶æˆåŠŸ
                    totalGold += 20;
                    feedbackText = "æˆåŠŸé¿å¼€ï¼";
                    feedbackColor = "#4caf50";
                }
            }

            document.getElementById('gold-count').innerText = totalGold;
            document.getElementById('feedback').innerText = feedbackText;
            document.getElementById('feedback').style.color = feedbackColor;

            trialIdx++;
            document.getElementById('trial-count').innerText = trialIdx;
            setTimeout(runTrial, 800);
        }

        function showResult() {
            // è®¡ç®—å†²åŠ¨æŠ‘åˆ¶å¾—åˆ†
            const nogoTrials = stats.nogoCorrect + stats.nogoError;
            const errorRate = nogoTrials > 0 ? stats.nogoError / nogoTrials : 0;

            // æ˜ å°„åˆ° 0-3 åˆ† (åˆ†æ•°è¶Šé«˜ï¼Œå†²åŠ¨ç¨‹åº¦è¶Šé«˜ï¼Œç¬¦åˆ PHQ/GAD è®¡åˆ†é€»è¾‘)
            let finalScore = 0;
            if (errorRate > 0.40) finalScore = 3;
            else if (errorRate > 0.20) finalScore = 2;
            else if (errorRate > 0.05) finalScore = 1;
            else finalScore = 0;

            // 1. å‘é€æ•°æ®ç»™çˆ¶ç½‘é¡µ (eid ä¿®æ”¹ä¸º inhibition é€‚é…ä½ çš„ Dims è¡¨)
            window.parent.postMessage({ 
                type: "experiment_result", 
                eid: "inhibition", 
                score: finalScore 
            }, "*");

            // 2. ç•Œé¢åˆ‡æ¢è‡³ä¸­æ€§â€œç»“æŸé¡µâ€ï¼Œä¸æ˜¾ç¤ºå…·ä½“åˆ†æ•°
            document.getElementById('status-bar').style.display = 'none';
            document.getElementById('ocean').style.display = 'none';
            document.getElementById('finish-screen').style.display = 'flex';
        }
    </script>
</body>
</html>