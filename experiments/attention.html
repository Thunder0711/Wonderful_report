<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è§†è§‰æœç´¢æµ‹è¯„ - ç»ƒä¹ å¢å¼ºç‰ˆ</title>
    <style>
        body { 
            background: #012d5e; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; align-items: center; justify-content: center; 
            height: 100vh; margin: 0; color: white; overflow: hidden; user-select: none; 
        }

        #game-screen { 
            width: 800px; height: 600px; background: #0277bd; 
            border: 6px solid #fff; border-radius: 30px; 
            position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); overflow: hidden; 
        }

        #status-bar { 
            height: 60px; background: rgba(255,255,255,0.95); 
            display: flex; align-items: center; justify-content: space-around; 
            color: #01579b; font-weight: bold; font-size: 18px; z-index: 10; 
        }

        #ocean { 
            flex: 1; position: relative; 
            background: radial-gradient(circle, #0288d1 0%, #01579b 100%); 
            cursor: default; 
        }

        #fixation { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); font-size: 60px; 
            color: white; display: none; z-index: 20; 
        }

        .stimulus { 
            position: absolute; width: 70px; height: 70px; 
            transition: transform 0.1s; cursor: default; z-index: 5; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); 
        }
        .stimulus:active { transform: scale(0.9); }

        #feedback-text {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 32px; font-weight: bold; z-index: 30; pointer-events: none;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        #mask-screen { 
            position: absolute; inset: 0; background: rgba(1, 87, 155, 0.98); 
            z-index: 100; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center; 
        }

        .btn-main { 
            padding: 15px 45px; background: #ffc107; color: #3e2723; 
            border: none; border-radius: 50px; cursor: pointer; 
            font-size: 22px; font-weight: bold; box-shadow: 0 5px 0 #ffa000; 
            margin-top: 20px; 
        }

        .icon-box { background: white; padding: 15px; border-radius: 15px; margin: 10px; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body>

<div id="game-screen">
    <div id="status-bar">
        <div id="mode-label" style="color: #ff5252;">[ ç»ƒä¹ æ¨¡å¼ ]</div>
        <div>ğŸ” è¿›åº¦: <span id="trial-count">0</span> / 20</div>
    </div>

    <div id="ocean">
        <div id="feedback-text"></div>
        <div id="fixation">+</div>
        <div id="stimuli-layer"></div>
    </div>

    <div id="mask-screen">
        <div id="ui-content">
            <h1 style="color: #ffeb3b;">ğŸŒŠ æ·±æµ·è§†è§‰æŒ‘æˆ˜</h1>
            <div style="background: white; color: #01579b; padding: 25px; border-radius: 20px; margin: 20px; max-width: 500px;">
                <p style="font-size: 18px; font-weight: bold;">æ¢é™©å®¶ï¼Œè¯·åœ¨é±¼ç¾¤ä¸­æ‰¾åˆ°ï¼š</p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0;">
                    <div id="target-template" style="width: 80px; height: 80px;"></div>
                    <div style="text-align: left;">
                        <span style="font-size: 22px; font-weight: bold; color: #d32f2f;">ç›®æ ‡ï¼šçº¢è‰²æ²³è±š</span><br>
                        <span style="font-size: 14px; color: #666;">ï¼ˆçº¢è‰² + åœ†å½¢ + æœ‰åˆºï¼‰</span>
                    </div>
                </div>
                <hr>
                <p style="font-size: 14px; color: #666;">
                    åˆ«ç‚¹é”™äº†å“¦ï¼å¹²æ‰°é¡¹æœ‰ï¼š<br>
                    è“è‰²æ²³è±š ğŸ¡ å’Œ çº¢è‰²é‡‘æªé±¼ ğŸŸ
                </p>
            </div>
            <button class="btn-main" id="start-btn" onclick="startGame()">å¼€å§‹ç»ƒä¹ </button>
        </div>
    </div>
</div>

<script>
    /**
     * 1. å®éªŒå‚æ•°é…ç½®
     * è¯¥ç»„ä»¶é’ˆå¯¹ K-12 å­¦ç”Ÿæ³¨æ„åŠ›ç­›æŸ¥è®¾è®¡ã€‚
     */
    const PRACTICE_TRIALS = 3;  // 3è½®ç»ƒä¹ 
    const FORMAL_TRIALS = 20;   // 20è½®æ­£å¼æµ‹è¯•
    const LIMIT_TIME = 5000; 
    
    let trialIdx = 0;
    let isPractice = true;
    let results = []; // ä»…å­˜å‚¨æ­£å¼æµ‹è¯•æ•°æ®
    let startTime = 0;
    let timer = null;
    let isWaitingResponse = false;

    const COLORS = { RED: '#d32f2f', BLUE: '#01579b' };
    const TUNA_PATH = (color) => `<svg viewBox="0 0 100 60"><path fill="${color}" d="M10,30 Q10,5 50,5 T90,30 T50,55 T10,30" stroke="white" stroke-width="2"/><circle fill="white" cx="30" cy="25" r="5"/></svg>`;
    const PUFFER_PATH = (color) => `<svg viewBox="0 0 100 100"><circle fill="${color}" cx="50" cy="50" r="35" stroke="white" stroke-width="2"/><path fill="${color}" d="M50 5 L55 20 L45 20 Z M95 50 L80 45 L80 55 Z M50 95 L45 80 L55 80 Z M5 50 L20 45 L20 55 Z" stroke="white"/><circle fill="white" cx="40" cy="40" r="6"/></svg>`;

    // åˆå§‹åŒ–å¼•å¯¼é¡µå›¾æ ‡ï¼ˆç¡®ä¿ä¸å®éªŒä¸­ä¸€è‡´ï¼‰
    document.getElementById('target-template').innerHTML = PUFFER_PATH(COLORS.RED);

    function getSetSize(idx) {
        if (isPractice) return 6; // ç»ƒä¹ é˜¶æ®µå›ºå®š 6 åª
        if (idx < 4) return 4;
        if (idx < 8) return 8;
        if (idx < 12) return 12;
        if (idx < 16) return 18;
        return 24;
    }

    function startGame() {
        document.getElementById('mask-screen').style.display = 'none';
        runTrial();
    }

    function runTrial() {
        const totalThisPhase = isPractice ? PRACTICE_TRIALS : FORMAL_TRIALS;
        if (trialIdx >= totalThisPhase) {
            if (isPractice) return transitionToFormal();
            else return handleExperimentEnd();
        }

        const layer = document.getElementById('stimuli-layer');
        const fix = document.getElementById('fixation');
        layer.innerHTML = '';
        document.getElementById('feedback-text').innerText = '';
        isWaitingResponse = false;

        // æ³¨è§†ç‚¹ (Fixation)
        fix.style.display = 'block';
        setTimeout(() => {
            fix.style.display = 'none';
            renderStage();
        }, 500 + Math.random() * 300);
    }

    function renderStage() {
        const layer = document.getElementById('stimuli-layer');
        const currentSize = getSetSize(trialIdx);
        const positions = generateSafePositions(currentSize);
        
        const targetPos = positions.pop();
        createFish(layer, targetPos, COLORS.RED, 'puffer', true);

        positions.forEach((pos, i) => {
            const isRedTuna = i % 2 === 0;
            const color = isRedTuna ? COLORS.RED : COLORS.BLUE;
            const shape = isRedTuna ? 'tuna' : 'puffer';
            createFish(layer, pos, color, shape, false);
        });

        startTime = Date.now();
        isWaitingResponse = true;
        timer = setTimeout(() => { if (isWaitingResponse) handleResponse(false, true); }, LIMIT_TIME);
    }

    function createFish(parent, pos, color, shape, isTarget) {
        const div = document.createElement('div');
        div.className = 'stimulus';
        div.style.left = pos.x + 'px';
        div.style.top = pos.y + 'px';
        div.innerHTML = (shape === 'tuna') ? TUNA_PATH(color) : PUFFER_PATH(color);
        div.onclick = () => { if (isWaitingResponse) handleResponse(isTarget, false); };
        parent.appendChild(div);
    }

    function handleResponse(isCorrect, isTimeout) {
        clearTimeout(timer);
        isWaitingResponse = false;
        const rt = isTimeout ? LIMIT_TIME : (Date.now() - startTime);

        // ç»ƒä¹ æ¨¡å¼æ˜¾ç¤ºåé¦ˆï¼Œæ­£å¼æ¨¡å¼é™é»˜
        if (isPractice) {
            const feedback = document.getElementById('feedback-text');
            feedback.innerText = isCorrect ? "ğŸŒŸ å¤ªæ£’äº†ï¼" : "âŒ ç‚¹é”™äº†å“¦";
            feedback.style.color = isCorrect ? "#ffeb3b" : "#ff5252";
        } else {
            results.push({ setSize: getSetSize(trialIdx), rt: rt, correct: isCorrect && !isTimeout });
        }

        trialIdx++;
        document.getElementById('trial-count').innerText = trialIdx;
        setTimeout(runTrial, isPractice ? 1200 : 600);
    }

    function transitionToFormal() {
        isPractice = false;
        trialIdx = 0;
        const mask = document.getElementById('mask-screen');
        const ui = document.getElementById('ui-content');
        ui.innerHTML = `
            <h1 style="color: #ffeb3b;">ç»ƒä¹ å®Œæˆï¼</h1>
            <p style="font-size: 18px; color: white;">ä½ å·²ç»æŒæ¡äº†è§„åˆ™ã€‚<br>æ¥ä¸‹æ¥å°†è¿›å…¥æ­£å¼æŒ‘æˆ˜ï¼Œå‡†å¤‡å¥½äº†å—ï¼Ÿ</p>
            <button class="btn-main" onclick="startGame()">å¼€å§‹æ­£å¼æŒ‘æˆ˜</button>
        `;
        document.getElementById('mode-label').innerText = "[ æ­£å¼æ¨¡å¼ ]";
        document.getElementById('mode-label').style.color = "#4caf50";
        document.getElementById('trial-count').innerText = "0";
        mask.style.display = 'flex';
    }

    function generateSafePositions(count) {
        const spots = [];
        const cols = 6, rows = 4;
        const cellW = 740 / cols, cellH = 480 / rows;
        let cells = [];
        for(let r=0; r<rows; r++) for(let c=0; c<cols; c++) cells.push({r, c});
        cells.sort(() => Math.random() - 0.5).slice(0, count).forEach(cell => {
            spots.push({
                x: cell.c * cellW + 30 + (Math.random() - 0.5) * 20,
                y: cell.r * cellH + 30 + (Math.random() - 0.5) * 20
            });
        });
        return spots;
    }

    function handleExperimentEnd() {
        const ui = document.getElementById('ui-content');
        const mask = document.getElementById('mask-screen');
        ui.innerHTML = `<h2 style="color:white;">æµ‹è¯„å·²å®Œæˆï¼</h2><p style="color:#e1f5fe;">æ­£åœ¨åŒæ­¥æ•°æ®ç»™é˜¿æŸ´...</p>`;
        mask.style.display = 'flex';

        const validResults = results.filter(r => r.correct);
        const acc = (validResults.length / FORMAL_TRIALS) * 100;
        const n = validResults.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        validResults.forEach(r => {
            sumX += r.setSize; sumY += r.rt;
            sumXY += r.setSize * r.rt; sumXX += r.setSize * r.setSize;
        });
        const slope = n > 1 ? (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX) : 0;

        let score = 0;
        if (acc < 70 || slope > 100) score = 3;
        else if (slope > 65) score = 2;
        else if (slope > 35) score = 1;
        else score = 0;

        setTimeout(() => {
            window.parent.postMessage({ 
                type: "experiment_result", 
                eid: "visual_search_slope", 
                score: score, 
                slope: slope.toFixed(1) 
            }, "*");
        }, 1500);
    }
</script>
</body>
</html>